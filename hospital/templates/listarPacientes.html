{% extends 'navegador.html' %}
{% load static %}

{% block title %}Lista de Pacientes{% endblock %}
{% block content %}
    <div class="container mt-3" style="z-index: 5;" id="lista">
        <!-- Lista de paciente -->
        <h2>Lista de Pacientes Activos</h2>
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Nombres</th>
                    <th>Apellidos</th>
                    <th>Opciones</th>
                </tr>
            </thead>
            <tbody>
            {% for usuario in pacientes %}
                <tr id="contenedor-paciente" class="fila-paciente">
                    <td data-usuario-info="nombre">{{ usuario.nombre }}</td>
                    <td data-usuario-info="apellido">{{ usuario.apellido }}</td>
                    <td>
                        <button id="info" onclick="muestraInfo(this)"> Informacion </button>
                        <button id="actualiza" onclick="actualizaInfo(this)"> Actualizar </button>
                        {% csrf_token %}
                        <button id="Elimina" onclick="eliminaInfo(this)"> Eliminar </button> 
                    </td>
                </tr>
            {% endfor %}
        </table>
    </div>
    
    <!-- boton informacion  -->
    <div id="info_paciente">
        <nav class="navbar navbar-expand-sm bg-white navbar-light border-bottom shadow-sm">
        <div class="container-fluid">
            <ul class="navbar-nav">
            <li class="nav-item">
                <a class="nav-link text-primary fw-semibold" href="#section1">Datos del Paciente</a>
            </li>
            <li class="nav-item">
                <a class="nav-link text-primary fw-semibold" href="#section2">Historial Médico</a>
            </li>
            <li class="nav-item">
                <a class="nav-link text-primary fw-semibold" href="#section3">Tratamientos</a>
            </li>
            </ul>

            <button class="btn btn-outline-danger ms-auto" onclick="cierraInfo()">
                Cerrar Información
            </button>
        </div>
        </nav>

        <div id="section1" class="container-fluid bg-info-subtle text-dark" style="padding:10px 5px;">
            <h1>Datos del Paciente</h1>
            <div class="container border p-3 rounded bg-light">
                <h4 class="mb-3">Información del Paciente</h4>
                <div class="row paciente-info">
                    <div class="col-md-6" data-campo="nombre"><strong>Nombre:</strong><span></span></div>
                    <div class="col-md-6" data-campo="apellido"><strong>Apellidos:</strong><span></span></div>
                    <div class="col-md-6" data-campo="edad"><strong>Edad:</strong><span></span></div>
                    <div class="col-md-6" data-campo="sexo"><strong>Género:</strong><span></span></div>
                    <div class="col-md-6" data-campo="telefono"><strong>Teléfono:</strong><span></span></div>
                </div>
            </div>
        </div>

        <div id="section2" class="container-fluid bg-light text-dark" style="padding:10px 5px;">
            <h1>Historial Médico</h1>
            <div class="container border p-3 rounded bg-light">
                <h4 class="mb-3">Sintomas</h4>
                <span></span>
            </div>
        </div>

        <div id="section3" class="container-fluid bg-secondary-subtle text-dark" style="padding:100px 20px;">
            <h1>Tratamientos</h1>
        </div>

    </div>

    <!-- boton actualiza  -->
    <div class="container mt-3" id="actualizaPaciente">
        <div class="d-flex align-items-start">   
            <h3>Actualizar Paciente</h3>
            <button class="btn btn-outline-danger ms-auto" onclick="cierraInfo()">
                Cerrar Información
            </button>
        </div>
            
        <form class="needs-validation" novalidate>
            {% csrf_token %}
            
            
            <div class="card mb-4 muestraInfo">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Datos Personales</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="nombre" class="form-label">Nombre:</label>
                            <input type="text" class="form-control" id="nombre" 
                                   placeholder="Nombre del paciente" name="nombre" 
                                   pattern="[A-Za-záéíóúÁÉÍÓÚñÑ\s]+" data-info="nombre" required>
                            <div class="invalid-feedback">Por favor ingrese un nombre válido (solo letras)</div>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="apellidos" class="form-label">Apellidos:</label>
                            <input type="text" class="form-control" id="apellidos" 
                                   placeholder="Apellidos del paciente" name="apellidos" 
                                   pattern="[A-Za-záéíóúÁÉÍÓÚñÑ\s]+" data-info="apellido" required>
                            <div class="invalid-feedback">Por favor ingrese apellidos válidos (solo letras)</div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label for="edad" class="form-label">Edad:</label>
                            <input type="number" class="form-control" id="edad" 
                                   placeholder="Edad" name="edad" min="0" max="120" data-info="edad" required>
                            <div class="invalid-feedback">La edad debe estar entre 0 y 120 años</div>
                        </div>
                    </div>

                </div>
            </div>

       
            <div class="card mb-4 muestraInfo">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Información Médica</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="sintomas" class="form-label">Síntomas:</label>
                        <textarea class="form-control" rows="5" id="sintomas" 
                                  name="sintomas" placeholder="Describa los síntomas del paciente" 
                                  data-info="sintomas" required></textarea>
                        <div class="invalid-feedback">Por favor describa los síntomas del paciente</div>
                    </div>
                </div>
            </div>
            <button id="enviar" type="button" class="btn btn-primary" onclick="enviarActualizacion()" disabled>Actualizar</button>
        </form>
    </div>


{% endblock %}

{% block scripts %}
    <script>
        const pacientes = JSON.parse('{{ pacientes_json|escapejs }}');
        const campos_modificados = new Set();
        const modificados = document.querySelectorAll('[data-info]');
        const boton_enviar = document.getElementById("enviar");
        let id_paciente;
        let filaPaciente;
        let contado=0;

        modificados.forEach(function(modificado) {
            modificado.addEventListener("input", function() {
                campos_modificados.add(this.dataset.info);
                if (campos_modificados.size > 0) {
                    boton_enviar.disabled = false; // Activar
                }
            });
        });


        async function eliminaInfo(boton){
            //obtener informacion del paciente
            const fila = boton.closest('tr');
            const filas = document.querySelectorAll('.fila-paciente');
            // Convierte NodeList a Array y encuentra el índice
            const indiceFila = Array.from(filas).indexOf(fila);
            id_paciente = pacientes[indiceFila].pk;
            //cambiar estado del paciente
            let datos = {idpaciente: id_paciente};
            try {
                const response = await fetch("/hospital/eliminar-paciente/", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": getCookie('csrftoken') // Función para obtener el token
                    },
                    body: JSON.stringify(datos)
                });
                
                const result = await response.json();
                if (!response.ok) {
                    throw new Error(result.error || 'Error en el servidor');
                }
                window.location.reload(true);
                
            } catch (error) {
                console.error("Error:", error);
                showNotification('error',
                error.message || 'Error al conectar con el servidor');
            }
        }
        
        async function enviarActualizacion() {
            let datos = {idpaciente: id_paciente};
    
            // Construir objeto de datos
            for (let valor of campos_modificados) {
                datos[valor] = document.querySelector(`[data-info="${valor}"]`).value;
            }
            try {
                const response = await fetch("/hospital/actualizar-paciente/", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": getCookie('csrftoken') // Función para obtener el token
                    },
                    body: JSON.stringify(datos)
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || 'Error en el servidor');
                }

                //actualizar informacion del paciente
                const campos = Array.from(campos_modificados.values());
                //showNotification('success', 'Paciente actualizado correctamente');
                const paciente = pacientes.find(p => p.pk == id_paciente);
                for(let campo of campos){
                    if (campo == "nombre" || campo == "apellido"){
                        filaPaciente.querySelector(`[data-usuario-info="${campo}"]`).textContent = datos[campo];
                    }
                    paciente.fields[campo] = datos[campo];
                }
                filaPaciente.classList = 'fila-paciente-activo';
                boton_enviar.disabled = true; // Desactivar
                campos_modificados.clear();
                cierraInfo();
                setTimeout(() => {
                    filaPaciente.classList = "";

                }, 2000);


            } catch (error) {
                console.error("Error:", error);
                showNotification('error',
                error.message || 'Error al conectar con el servidor');
            }
        }

        // Funciones auxiliares
        function showNotification(type, message) {
            // Implementar notificación bonita (ej: Toast)
            const notifications = document.getElementById('notifications') || createNotificationsContainer();
            const notification = document.createElement('div');
            notification.id="noti";
            contado++;
            notification.innerHTML = `
                <span class="icon">${type === 'success' ? '✓' : '!'}</span>
                <span class="message">${message}</span>
            `;
            notifications.prepend(notification);
            setTimeout(() => {
                notification.remove();
                contado--;
                if(contado == 0){
                    document.getElementById('notifications').remove();
                }
            }, 2000);
        }

        function createNotificationsContainer() {
            const container = document.createElement('div');
            container.id = 'notifications';
            document.body.appendChild(container);
            return container;
        }

        // Función para obtener el token CSRF (si no la tienes)
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        function actualizaInfo(boton){
            
            //mostrar informacion paciente
            const informacion = document.getElementById("actualizaPaciente");
            informacion.style.display = "block";

            //bloquear nav y lista
            const lista = document.getElementById("lista");
            lista.style.filter = "blur(5px)"
            lista.style.pointerEvents = "none";
            lista.style.userSelect = "none";
            const navegador = document.getElementById("nav");
            navegador.style.filter = "blur(5px)"
            navegador.style.pointerEvents = "none";
            navegador.style.userSelect = "none";

            //obtener informacion del paciente
            const fila = boton.closest('tr');
            filaPaciente = fila;
            const filas = document.querySelectorAll('.fila-paciente');
            // Convierte NodeList a Array y encuentra el índice
            const indiceFila = Array.from(filas).indexOf(fila);
            id_paciente = pacientes[indiceFila].pk;
            document.querySelectorAll(".muestraInfo [data-info]").forEach(el => {
                const campo = el.getAttribute("data-info");
                if (campo == "id"){
                    el.value = pacientes[indiceFila].pk
                }else{
                    el.value = pacientes[indiceFila].fields[campo];
                }
            });;
        }

        function muestraInfo(boton){
            //mostrar informacion paciente
            const informacion = document.getElementById("info_paciente");
            informacion.style.display = "block";

            //bloquear nav y lista
            const lista = document.getElementById("lista");
            lista.style.filter = "blur(5px)"
            lista.style.pointerEvents = "none";
            lista.style.userSelect = "none";
            const navegador = document.getElementById("nav");
            navegador.style.filter = "blur(5px)"
            navegador.style.pointerEvents = "none";
            navegador.style.userSelect = "none";

        //obtener informacion del paciente
            const fila = boton.closest('tr');
            const filas = document.querySelectorAll('.fila-paciente');
            // Convierte NodeList a Array y encuentra el índice
            const indiceFila = Array.from(filas).indexOf(fila);
            document.querySelectorAll(".paciente-info [data-campo]").forEach(el => {
                const campo = el.getAttribute("data-campo");
                el.querySelector("span").textContent = pacientes[indiceFila].fields[campo] || "N/A";
            });;
        }

        function cierraInfo(){
            document.getElementById('info_paciente').style.display='none';
            document.getElementById('actualizaPaciente').style.display='none';
            const lista = document.getElementById("lista");
            lista.style.filter = ""
            lista.style.pointerEvents = "";
            lista.style.userSelect = "";
            const navegador = document.getElementById("nav");
            navegador.style.filter = ""
            navegador.style.pointerEvents = "";
            navegador.style.userSelect = "";
        }
        
    </script>
{% endblock %}